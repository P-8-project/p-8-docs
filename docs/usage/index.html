<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>P-8 | Documentation | Usage</title>
<meta content="Get started with realtime using our developer guide. " name="description"/>
<link href="index.html" rel="canonical"/>
<link href="../../feed.xml" rel="alternate" title="P-8" type="application/rss+xml"/>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<!-- open graph info -->
<meta content="P-8 | Documentation | Usage" property="og:title"/>
<meta content="P-8" property="og:site_name"/>
<meta content="website" property="og:type"/>
<meta content="Get started with realtime using our developer guide." property="og:description"/>
<meta content="https://P-8.org/image/icon-300x300.png" property="og:image"/>
<meta content="https://P-8.org/image/icon-300x300.png" name="twitter:image"/>
<link href="../../image/favicon.png" rel="icon" type="image/png">
<!-- Stylesheets -->
<link href="../../css/main.css" rel="stylesheet"/>
<!-- APIs -->
<link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,400|Merriweather:300,400" rel="stylesheet"/>
<!-- jQuery -->
<script crossorigin="anonymous" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
<script src="../../js/handlebars.js"></script>
<script src="../../js/tabbed-examples.js"></script>
</link></head>
<body class="page docs">
<div style="display: none;"><img src="../../image/dots-div.svg"/></div>
<header class="primary wrapper">
<nav class="primary" id="top" role="navigation">
<aside class="logo">
<a href="../../index.html"><img src="../../image/logo.png"/></a>
</aside>
<aside class="links">
<a href="../about/index.html">Docs</a>
<a href="https://github.com/P-8-project/P-8">Code</a>

</aside>
<img class="mobile-handle" src="../../image/mobile-handle.svg"/>
</nav>
</header>
<div class="consent-box" id="consent-box">
<div class="width">
<p>We use cookies to provide our services and for analytics and marketing. To find out more about our use of cookies, please see our <a href="https://fanout.io/legal/privacy-policy/">Privacy Policy</a>. By continuing to browse our website, you agree to our use of cookies.</p>
<button class="button ghost" href="#" id="consent-ok">OK</button>
</div>
</div>
<header class="page-header"><h1>Documentation</h1></header>
<div class="div"></div>
<div class="content wrapper" style="position: relative;">
<nav class="sidebar">
<ul>
<li><a href="../about/index.html">About</a></li>
<ul>
<li><a href="../about/index.html#introduction">Introduction</a></li>
<li><a href="../about/index.html#how-it-works">How it works</a></li>
<li></li>
<li><a href="../about/index.html#license">License</a></li>
</ul>
<li><a href="../install/index.html">Install</a></li>
<ul>
<li><a href="../install/index.html#packages">Packages</a></li>
<li><a href="../install/index.html#building-from-source">Building from source</a></li>
<li><a href="../install/index.html#running">Running</a></li>
<li><a href="../install/index.html#upgrading">Upgrading</a></li>
</ul>
<li><a href="../getting-started/index.html">Getting started</a></li>
<ul>
<li><a href="../getting-started/index.html#quickstart">Quickstart</a></li>
<li><a href="../getting-started/index.html#video-walkthrough">Video walkthrough</a></li>
</ul>
<li><a href="../configuration/index.html">Configuration</a></li>
<ul>
<li><a href="../configuration/index.html#config-files">Config files</a></li>
<li><a href="../configuration/index.html#routes">Routes</a></li>
<li><a href="../configuration/index.html#proxying">Proxying</a></li>
<li><a href="../configuration/index.html#ssl">SSL</a></li>
</ul>
<li>Usage</li>
<ul>
<li><a href="index.html#subscribing">Subscribing</a></li>
<li><a href="index.html#publishing">Publishing</a></li>
<ul>
<li><a href="index.html#publishing-overview">Publishing overview</a></li>
<li><a href="index.html#publish-actions">Publish actions</a></li>
<li><a href="index.html#binary-data">Binary data</a></li>
</ul>
<li><a href="index.html#transports">Transports</a></li>
<ul>
<li><a href="index.html#http-streaming">HTTP streaming</a></li>
<li><a href="index.html#server-sent-events">Server-sent events</a></li>
<li><a href="index.html#http-long-polling">HTTP long-polling</a></li>
<li><a href="index.html#websockets">WebSockets</a></li>
</ul>
<li><a href="index.html#libraries">Libraries</a></li>
<li><a href="index.html#browser-features">Browser features</a></li>
<ul>
<li><a href="index.html#auto-cross-origin">Auto cross-origin</a></li>
<li><a href="index.html#sockjs">SockJS</a></li>
</ul>
</ul>
<li><a href="../advanced/index.html">Advanced topics</a></li>
<ul>
<li><a href="../advanced/index.html#sequence-ids">Sequence IDs</a></li>
<li><a href="../advanced/index.html#message-de-duping">Message de-duping</a></li>
<li><a href="../advanced/index.html#keep-alives">Keep-alives</a></li>
<li><a href="../advanced/index.html#commands">Commands</a></li>
<li><a href="../advanced/index.html#stats-socket">Stats socket</a></li>
<li><a href="../advanced/index.html#message-filtering">Message filtering</a></li>
<li><a href="../advanced/index.html#paged-streaming">Paged streaming</a></li>
<li><a href="../advanced/index.html#reliability">Reliability</a></li>
<li><a href="../advanced/index.html#message-queues">Message queues</a></li>
<li><a href="../advanced/index.html#subscription-forwarding">Subscription forwarding</a></li>
<li><a href="../advanced/index.html#multiple-processes">Multiple processes</a></li>
<li><a href="../advanced/index.html#proxy-chaining">Proxy chaining</a></li>
</ul>
<li><a href="../examples/index.html">Examples</a></li>
<ul>
<li><a href="../examples/index.html#headline">Headline</a></li>
<li><a href="../examples/index.html#leaderboard">Leaderboard</a></li>
<li><a href="../examples/index.html#chat">Chat</a></li>
<li><a href="../examples/index.html#todo-list">Todo list</a></li>
<li><a href="../examples/index.html#live-text-editor">Live text editor</a></li>
<li><a href="../examples/index.html#webhookinbox">WebhookInbox</a></li>
<li><a href="../examples/index.html#audio-stream">Audio stream</a></li>
</ul>
<li><a href="../protocols/index.html">Protocols</a></li>
<ul>
<li><a href="../protocols/grip/index.html">Generic Realtime Intermediary Protocol</a></li>
<li><a href="../protocols/websocket-over-http/index.html">WebSocket-over-HTTP</a></li>
<li><a href="https://rfc.zeromq.org/spec:33/ZHTTP/">ZHTTP</a></li>
</ul>
</ul>
</nav>
<nav class="navbar-mobile-handle">Docs Menu</nav>
<section class="docs">
<h1 id="usage">Usage</h1>
<h2 id="subscribing">Subscribing</h2>
<p>When clients make HTTP requests or WebSocket connections to P-8, what happens next depends on the instructions provided by your backend web service. These instructions can include subscribing the client to one or more channels.</p>
<p>For HTTP-based transports, this is typically done with response headers. For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Grip-Hold: stream
Grip-Channel: mychannel
</code></pre></div></div>
<p>For the WebSocket transport, this is done using control messages sent by the backend to P-8. For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:{"type": "subscribe", "channel": "mychannel"}
</code></pre></div></div>
<p>It’s important to understand that clients don’t assert their own subscriptions. Clients make arbitrary HTTP requests or send arbitrary WebSocket messages, and it is your backend that determines whether or not clients should be subscribed to anything. Your channel schema remains private between P-8 and your backend server, and in fact clients may not even be aware that publish-subscribe activities are occurring.</p>
<p>See the <a href="index.html#transports">Transports</a> section below for transport-specific subscribing details.</p>
<h2 id="publishing">Publishing</h2>
<h3 id="publishing-overview">Publishing Overview</h3>
<p>Data is published to clients by making a request to P-8’s HTTP control API or input ZeroMQ sockets. There are four possible inputs:</p>
<ul>
<li>
<p>POST to <code class="language-plaintext highlighter-rouge">/publish</code> on the HTTP control API (port 5561 by default).</p>
</li>
<li>
<p>Use a ZeroMQ PUSH socket to send to the input PULL socket (port 5560 by default).</p>
</li>
<li>
<p>Use a ZeroMQ PUB socket to send to the input SUB socket (port 5562 by default).</p>
</li>
<li>
<p>Use a ZeroMQ REQ/DEALER socket to send to the input REP socket (port 5563 by default). See <a href="../advanced/index.html#publish">the publish command</a>.</p>
</li>
</ul>
<p>Messages are formatted as “items” in either JSON or tnetstring format, depending on the input used. Here’s an example of an item:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"an-item-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"http-stream"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a chunk of data</span><span class="se">\n</span><span class="s2">"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>With the HTTP control API, the item is enveloped to allow sending multiple items at once:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost:5561</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"an-item-id"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http-stream"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a chunk of data</span><span class="se">\n</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>With the ZeroMQ input PULL socket, each message is single-part containing one item in tnetstring format or JSON format, prefixed with a single character (<code class="language-plaintext highlighter-rouge">T</code> or <code class="language-plaintext highlighter-rouge">J</code>) indicating the format type.</p>
<p>Example tnetstring message:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>T104:7:formats,49:11:http-stream,30:7:content,16:a chunk of data
,}}7:channel,9:mychannel,2:id,10:an-item-id,}
</code></pre></div></div>
<p>Note that there’s a literal newline in the above payload, after the word “data”.</p>
<p>Example JSON message:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>J{"id": "an-item-id", "channel": "mychannel", "formats": {"http-stream": {"content": "a chunk of data\n"}}}
</code></pre></div></div>
<p>With the ZeroMQ input SUB socket, each message is multi-part, where the first part is the channel, and the second part is an item payload in one of the above formats. The <code class="language-plaintext highlighter-rouge">channel</code> field is ignored in the item payload.</p>
<p>One or more transport formats must be provided for each item. Messages are only delivered to connections if there is a format for the connection type. The defined formats are <code class="language-plaintext highlighter-rouge">http-stream</code>, <code class="language-plaintext highlighter-rouge">http-response</code>, and <code class="language-plaintext highlighter-rouge">ws-message</code>.</p>
<p>Clients never publish data to other clients. Only the backend server can publish data.</p>
<p>See the <a href="index.html#transports">Transports</a> section for transport-specific publishing details.</p>
<h3 id="publish-actions">Publish actions</h3>
<p>Transport formats can specify one of several actions:</p>
<ul>
<li>
<p><code class="language-plaintext highlighter-rouge">send</code>: The included content should be delivered to subscribers. This is the default if unspecified.</p>
</li>
<li>
<p><code class="language-plaintext highlighter-rouge">hint</code>: The content to be delivered to subscribers must be externally retrieved. No content is included in the published item.</p>
</li>
<li>
<p><code class="language-plaintext highlighter-rouge">close</code>: Any requests or connections associated with the subscription should be ended/closed.</p>
</li>
<li>
<p><code class="language-plaintext highlighter-rouge">refresh</code>: Trigger any WebSocket-over-HTTP sessions associated with the subscription to make requests to the backend. This can be useful for applying GRIP instructions (e.g. adding/removing subscriptions) to existing WebSocket-over-HTTP sessions without requiring action from clients.</p>
</li>
</ul>
<p>The <code class="language-plaintext highlighter-rouge">hint</code> action is useful if it is difficult for the publisher to generate the needed content, or if you need to publish a large payload. This only works for <a href="../advanced/index.html#reliability">reliable</a> connections, and the effect is similar to the <a href="../advanced/index.html#recover">Recover command</a> except it is processed immediately rather than soon-ish.</p>
<p>Example published hint:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost:5561</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"an-item-id"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"prev-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"another-item-id"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http-stream"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hint"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">close</code> action tells P-8 to end/close the HTTP request or WebSocket connection with the subscriber. This works for HTTP streaming and WebSockets. It doesn’t work for HTTP long-polling, since publishing data ends the request anyway and it’s better to send something than nothing.</p>
<p>Example published close:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost:5561</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"an-item-id"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http-stream"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"close"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>For the <code class="language-plaintext highlighter-rouge">ws-message</code> format, you can provide a close code and reason:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost:5561</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"an-item-id"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ws-message"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"close"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="mi">1013</span><span class="p">,</span><span class="w">
          </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bye for now"</span><span class="p">,</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<h3 id="binary-data">Binary data</h3>
<p>P-8 supports publishing binary data to subscribers.</p>
<p>Internally, P-8 treats all content as bytes, and if you publish data to the ZeroMQ PULL or SUB sockets using tnetstring format, then the payload is already binary. The issue of sending binary data only arises when JSON format is used, such as with the HTTP publish command.</p>
<p>To send binary data within a JSON-formatted item, the data must be Base64-encoded and set to an appropriate <code class="language-plaintext highlighter-rouge">-bin</code>-suffixed field. For <code class="language-plaintext highlighter-rouge">http-stream</code> and <code class="language-plaintext highlighter-rouge">ws-message</code> items, set <code class="language-plaintext highlighter-rouge">content-bin</code> with Base64 data and omit <code class="language-plaintext highlighter-rouge">content</code>. For <code class="language-plaintext highlighter-rouge">http-response</code>, set <code class="language-plaintext highlighter-rouge">body-bin</code> with Base64 data and omit <code class="language-plaintext highlighter-rouge">body</code>.</p>
<p>If you are using a library for publishing, it is possible the library takes care of this for you. For example, the Python <code class="language-plaintext highlighter-rouge">gripcontrol</code> library automatically does the right thing with HTTP data, and for WebSockets all you need to do is set <code class="language-plaintext highlighter-rouge">binary=True</code> on the format object.</p>
<h2 id="transports">Transports</h2>
<h3 id="http-streaming">HTTP streaming</h3>
<p>When P-8 receives an HTTP request from a client, P-8 forwards it as-is to the origin server that you specified in the <code class="language-plaintext highlighter-rouge">routes</code> file. The origin server then tells P-8 either to respond immediately with a normal HTTP response or to hold the HTTP connection open instead. If a connection is held open, then it can be used later on for data pushing.</p>
<p>You can service incoming HTTP requests however you want. Normal responses sent to P-8 will be relayed to clients as-is. To cause a request to be held open and subscribed to channels you need to include special instructions via headers. Include a <code class="language-plaintext highlighter-rouge">Grip-Hold</code> header to indicate that a request should be held open. For streaming, its value should be <code class="language-plaintext highlighter-rouge">stream</code> (for long-polling, see <a href="index.html#http-long-polling">HTTP long-polling</a>).</p>
<p>For example, here’s how the origin server should respond to hold a request open as a stream, subscribed to <code class="language-plaintext highlighter-rouge">mychannel</code>:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/plain</span>
<span class="na">Grip-Hold</span><span class="p">:</span> <span class="s">stream</span>
<span class="na">Grip-Channel</span><span class="p">:</span> <span class="s">mychannel</span>

Stream opened, prepare yourself
</code></pre></div></div>
<aside><header>Note</header>To subscribe a request to multiple channels, respond with a comma-separated list of channels, or multiple <code class="highlighter-rouge">Grip-Channel</code> headers.</aside>
<p>When P-8 receives this response from your origin server, it will process it as an instruction. At this point, the HTTP request/response interaction between P-8 and the origin server is complete, but the HTTP request/response interaction between the client and P-8 remains.</p>
<p>Constructing a hold response is easy in your favorite language:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="s">'Stream opened, prepare yourself!</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">'text/plain'</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Grip-Hold'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'stream'</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Grip-Channel'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'mychannel'</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'text/plain'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Grip-Hold'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'stream'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Grip-Channel'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'mychannel'</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="s2">"Stream opened, prepare yourself!</span><span class="se">\n</span><span class="s2">"</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/plain'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Grip-Hold: stream'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Grip-Channel: mychannel'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
Stream opened, prepare yourself!
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Grip-Hold</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">stream</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Grip-Channel</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">'</span><span class="s1">Stream opened, prepare yourself!</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0.0.0.0</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">set_hold_stream</span>

<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">set_hold_stream</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'mychannel'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">'Stream opened, prepare yourself!</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">'application/json'</span><span class="p">)</span>
</code></pre></div> </div>
</div>
<p>When a client makes a request through P-8 and your origin server responds with a hold instruction in stream mode as shown above, then the client will immediately receive an initial response:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/plain</span>
<span class="na">Transfer-Encoding</span><span class="p">:</span> <span class="s">chunked</span>

Stream opened, prepare yourself!
</code></pre></div></div>
<p>Note that the <code class="language-plaintext highlighter-rouge">Grip-*</code> headers were stripped. Also, the request won’t have <code class="language-plaintext highlighter-rouge">Content-Length</code> set, so that it can stay open indefinitely as you publish additional body content.</p>
<p>Whenever you want to send data to listening clients, publish an “HTTP stream” payload containing the content:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install gripcontrol
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">GripPubControl</span>

<span class="n">pub</span> <span class="o">=</span> <span class="n">GripPubControl</span><span class="p">({</span>
    <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">pub</span><span class="p">.</span><span class="n">publish_http_stream</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span> <span class="s">'hello there</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install gripcontrol</span>
<span class="nb">require</span> <span class="s1">'gripcontrol'</span>

<span class="n">pub</span> <span class="o">=</span> <span class="no">GripPubControl</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">pub</span><span class="p">.</span><span class="nf">publish_http_stream_async</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span> <span class="s2">"hello there</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// composer require fanout/gripcontrol</span>

<span class="nv">$pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GripPubControl</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">));</span>

<span class="nv">$pub</span><span class="o">-&gt;</span><span class="nf">publish_http_stream</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span> <span class="s1">'hello there\n'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="c1">// npm install --save grip</span>
<span class="kd">var</span> <span class="nx">grip</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">grip</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">GripPubControl</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">control_uri</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:5561</span><span class="dl">'</span>
<span class="p">});</span>

<span class="nx">pub</span><span class="p">.</span><span class="nx">publishHttpStream</span><span class="p">(</span><span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hello there</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py or elsewhere:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">HttpStreamFormat</span>
<span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">publish</span>

<span class="n">publish</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span> <span class="n">HttpStreamFormat</span><span class="p">(</span><span class="s">'hello there</span><span class="se">\n</span><span class="s">'</span><span class="p">))</span>
</code></pre></div> </div>
</div>
<p>If there’s no library for your programming language, publishing is just one HTTP POST:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http-stream"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello there</span><span class="se">\n</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Stream holds remain open and can be repeatedly pushed to. Content you send may be of any type. In the above examples, we are publishing plain text lines instead of JSON.</p>
<p>You can also stream data using <a href="index.html#server-sent-events">Server-sent events</a>.</p>
<h3 id="server-sent-events">Server-sent events</h3>
<p>P-8 makes it easy to implement Server-Sent Events. Simply use <a href="index.html#http-streaming">HTTP streaming</a>, with the following guidelines for holding and publishing.</p>
<p>On the origin server, respond with hold instructions using <code class="language-plaintext highlighter-rouge">stream</code> mode and content type <code class="language-plaintext highlighter-rouge">text/event-stream</code>:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">'text/event-stream'</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Grip-Hold'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'stream'</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Grip-Channel'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'mychannel'</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'text/event-stream'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Grip-Hold'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'stream'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Grip-Channel'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'mychannel'</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: text/event-stream'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Grip-Hold: stream'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Grip-Channel: mychannel'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/event-stream</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Grip-Hold</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">stream</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Grip-Channel</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0.0.0.0</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">set_hold_stream</span>

<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">set_hold_stream</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'mychannel'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">'text/event-stream'</span><span class="p">)</span>
</code></pre></div> </div>
</div>
<aside><header>Note</header>To subscribe a request to multiple channels, respond with a comma-separated list of channels, or multiple <code class="highlighter-rouge">Grip-Channel</code> headers.</aside>
<p>Then, whenever you want to send data, publish an HTTP stream payload containing SSE formatting:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install gripcontrol
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">GripPubControl</span>

<span class="n">pub</span> <span class="o">=</span> <span class="n">GripPubControl</span><span class="p">({</span>
    <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">pub</span><span class="p">.</span><span class="n">publish_http_stream</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span>
    <span class="s">'event: update</span><span class="se">\n</span><span class="s">data: hello world</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install gripcontrol</span>
<span class="nb">require</span> <span class="s1">'gripcontrol'</span>

<span class="n">pub</span> <span class="o">=</span> <span class="no">GripPubControl</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">pub</span><span class="p">.</span><span class="nf">publish_http_stream_async</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span>
    <span class="s2">"event: update</span><span class="se">\n</span><span class="s2">data: hello world</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// composer require fanout/gripcontrol</span>

<span class="nv">$pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GripPubControl</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">));</span>

<span class="nv">$pub</span><span class="o">-&gt;</span><span class="nf">publish_http_stream</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span>
    <span class="s1">'event: update\ndata: hello world\n\n'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="c1">// npm install --save grip</span>
<span class="kd">var</span> <span class="nx">pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">GripPubControl</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">control_uri</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:5561</span><span class="dl">'</span>
<span class="p">});</span>

<span class="nx">pub</span><span class="p">.</span><span class="nx">publishHttpStream</span><span class="p">(</span><span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">event: update</span><span class="se">\n</span><span class="s1">data: hello world</span><span class="se">\n\n</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py or elsewhere:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">HttpStreamFormat</span>
<span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">publish</span>

<span class="n">publish</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span> <span class="n">HttpStreamFormat</span><span class="p">(</span>
    <span class="s">'event: update</span><span class="se">\n</span><span class="s">data: hello world</span><span class="se">\n\n</span><span class="s">'</span><span class="p">))</span>
</code></pre></div> </div>
</div>
<h3 id="http-long-polling">HTTP long-polling</h3>
<p>When P-8 receives an HTTP request from a client, P-8 forwards it as-is to the origin server that you specified in the <code class="language-plaintext highlighter-rouge">routes</code> file. The origin server then tells P-8 either to respond immediately with a normal HTTP response or to hold the HTTP connection open instead. If a connection is held open, then it can be used later on for data pushing. When data is to be pushed over a held connection, the complete HTTP response is specified, headers and all.</p>
<p>You can service incoming HTTP requests however you want. Normal responses sent to P-8 will be relayed to clients as-is. To cause a request to be held open and subscribed to channels you need to include special instructions via headers. Include a <code class="language-plaintext highlighter-rouge">Grip-Hold</code> header to indicate that a request should be held open. For long-polling, its value should be <code class="language-plaintext highlighter-rouge">response</code> (for streaming, see <a href="index.html#http-streaming">HTTP streaming</a>).</p>
<p>For example, here’s how the origin server should respond to hold a request open as a long-poll, subscribed to <code class="language-plaintext highlighter-rouge">mychannel</code>:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">Grip-Hold</span><span class="p">:</span> <span class="s">response</span>
<span class="na">Grip-Channel</span><span class="p">:</span> <span class="s">mychannel</span>

<span class="p">{}</span><span class="w">
</span></code></pre></div></div>
<aside><header>Note</header>To subscribe a request to multiple channels, respond with a comma-separated list of channels, or multiple <code class="highlighter-rouge">Grip-Channel</code> headers.</aside>
<p>When P-8 receives this response from your origin server, it will process it as an instruction rather than relaying it to the client. At this point, the HTTP request/response interaction between P-8 and the origin server is complete, but the HTTP request/response interaction between the client and P-8 remains.</p>
<p>After 55 seconds pass (you can override this with <code class="language-plaintext highlighter-rouge">Grip-Timeout</code>), the request will time out and P-8 will send the above response to the client with the <code class="language-plaintext highlighter-rouge">Grip-*</code> headers stripped. Here we are basically saying that if there is no data to publish on this channel before the request times out, then the client should receive an empty JSON object.</p>
<p>For example, if the request times out, then the client would see something like this:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{}</span><span class="w">
</span></code></pre></div></div>
<p>Of course, you may specify any content as the timeout response. You can use any headers and the body doesn’t have to be JSON.</p>
<p>Constructing a hold response is easy in your favorite language:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">'{}</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">'application/json'</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Grip-Hold'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'response'</span>
    <span class="n">response</span><span class="p">[</span><span class="s">'Grip-Channel'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'mychannel'</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="s2">"{}</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/json'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Grip-Hold'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'response'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Grip-Channel'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'mychannel'</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/json'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Grip-Hold: response'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Grip-Channel: mychannel'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
{}
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Grip-Hold</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">response</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Grip-Channel</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">'</span><span class="s1">{}</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0.0.0.0</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">set_hold_longpoll</span>

<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
    <span class="n">set_hold_longpoll</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'mychannel'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">'{}</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">'application/json'</span><span class="p">)</span>
</code></pre></div> </div>
</div>
<p>Whenever you want to send data to listening clients, publish an “HTTP response” payload containing the content:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install gripcontrol
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">GripPubControl</span>

<span class="n">pub</span> <span class="o">=</span> <span class="n">GripPubControl</span><span class="p">({</span>
    <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">pub</span><span class="p">.</span><span class="n">publish_http_response</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span> <span class="s">'{"hello": "world"}</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install gripcontrol</span>
<span class="nb">require</span> <span class="s1">'gripcontrol'</span>

<span class="n">pub</span> <span class="o">=</span> <span class="no">GripPubControl</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">pub</span><span class="p">.</span><span class="nf">publish_http_response_async</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span>
    <span class="s2">"{</span><span class="se">\"</span><span class="s2">hello"</span><span class="p">:</span> <span class="s2">"world</span><span class="se">\"</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// composer require fanout/gripcontrol</span>

<span class="nv">$pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GripPubControl</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">));</span>

<span class="nv">$pub</span><span class="o">-&gt;</span><span class="nf">publish_http_response</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span>
    <span class="s1">'{"hello": "world"}\n'</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="c1">// npm install --save grip</span>
<span class="kd">var</span> <span class="nx">grip</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">grip</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">GripPubControl</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">control_uri</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:5561</span><span class="dl">'</span>
<span class="p">});</span>

<span class="nx">pub</span><span class="p">.</span><span class="nx">publishHttpResponse</span><span class="p">(</span><span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">{"hello": "world"}</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py or elsewhere:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">HttpResponseFormat</span>
<span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">publish</span>

<span class="n">publish</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span>
    <span class="n">HttpResponseFormat</span><span class="p">(</span><span class="s">'{"hello": "world"}</span><span class="se">\n</span><span class="s">'</span><span class="p">))</span>
</code></pre></div> </div>
</div>
<p>If there’s no library for your programming language, publishing is just one HTTP POST:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http-response"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">hello</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">world</span><span class="se">\"</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>In the above publishing examples, we are specifying the HTTP response body to send to listening clients. The headers in the original instructional response will be merged with this content, minus any <code class="language-plaintext highlighter-rouge">Grip-*</code> headers. After publishing data, clients with held requests would receive a response looking like this:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="nl">"hello"</span><span class="p">:</span><span class="w"> </span><span class="s2">"world"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>For consuming a long-polling API from the browser, we recommend the <a href="https://github.com/fanout/pollymer">Pollymer AJAX library</a> (not to be confused with <a href="http://polymer-project.org">Polymer</a>).</p>
<h3 id="websockets">WebSockets</h3>
<p>When an incoming WebSocket connection request is received, P-8 opens a WebSocket connection (or uses an emulation over HTTP, see below) to the origin server that you specified in the <code class="language-plaintext highlighter-rouge">routes</code> file. P-8 does not accept the incoming WebSocket connection from the client until its outbound WebSocket connection has been accepted by the origin. Once the connections are established, messages can flow end-to-end in either direction. Using special control messages, you can subscribe connections to channels and then publish WebSocket messages to be injected into those connections.</p>
<p>P-8 communicates with the origin server in one of two modes:</p>
<ol>
<li>
<p><strong>Normal WebSockets:</strong> For every WebSocket connection between a client and P-8, there will be a corresponding WebSocket connection between P-8 and the origin server.</p>
</li>
<li>
<p><strong>WebSocket-over-HTTP protocol:</strong> Instead of using a WebSocket connection to the origin, P-8 encodes WebSocket events into HTTP requests/responses. Events include <code class="language-plaintext highlighter-rouge">OPEN</code>, <code class="language-plaintext highlighter-rouge">TEXT</code>, <code class="language-plaintext highlighter-rouge">PING</code>, <code class="language-plaintext highlighter-rouge">PONG</code>, and <code class="language-plaintext highlighter-rouge">CLOSE</code>, and are encoded in a format similar to HTTP chunked encoding. You don’t really have to think about the encoding, though, as our server libraries take care of it for you. For details, see the <a href="../protocols/websocket-over-http/index.html">WebSocket-over-HTTP specification</a>.</p>
</li>
</ol>
<p>We recommend using the WebSocket-over-HTTP protocol unless you have a good reason not to use it. The approach is great for stateless application protocols, and the origin server doesn’t have to maintain long-lived connections nor even support WebSockets. The one gotcha is that the origin server can only send spontaneous messages by publishing, but in a stateless protocol this should be expected. The WebSocket-over-HTTP mode is enabled by setting the <code class="language-plaintext highlighter-rouge">over_http</code> option on the target in the routes file.</p>
<p>Having P-8 proxy your WebSocket connections alone is not very interesting. In order to use publish-subscribe, the <code class="language-plaintext highlighter-rouge">grip</code> WebSocket extension must be negotiated. P-8 will include a <code class="language-plaintext highlighter-rouge">Sec-WebSocket-Extensions</code> request header with this extension, which must be acknowledged in the origin response. You need to do this regardless of whether P-8 is communicating with your server using a normal WebSocket or with the WebSocket-over-HTTP protocol.</p>
<p>For example, a WebSocket connection request might look like this:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/path</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Upgrade</span><span class="p">:</span> <span class="s">websocket</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">Upgrade</span>
<span class="na">Sec-WebSocket-Version</span><span class="p">:</span> <span class="s">13</span>
<span class="na">Sec-WebSocket-Key</span><span class="p">:</span> <span class="s">dGhlIHNhbXBsZSBub25jZQ=</span>
<span class="na">Sec-WebSocket-Extensions</span><span class="p">:</span> <span class="s">grip</span>
</code></pre></div></div>
<p>In which case the origin server should respond as such:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">101</span> <span class="ne">Switching Protocols</span>
<span class="na">Upgrade</span><span class="p">:</span> <span class="s">websocket</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">Upgrade</span>
<span class="na">Sec-WebSocket-Accept</span><span class="p">:</span> <span class="s">s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span>
<span class="na">Sec-WebSocket-Extensions</span><span class="p">:</span> <span class="s">grip</span>
</code></pre></div></div>
<p>If P-8 is communicating to the origin server using the WebSocket-over-HTTP protocol, then a connection request might look like the example below. Note that the characters <code class="language-plaintext highlighter-rouge">\r\n</code> represent a two-byte sequence of carriage return and newline.</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/path</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Sec-WebSocket-Extensions</span><span class="p">:</span> <span class="s">grip</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">application/websocket-events</span>

OPEN\r\n
</code></pre></div></div>
<p>The origin server should then respond accordingly. Note that even though this is not a WebSocket connection, the <code class="language-plaintext highlighter-rouge">Sec-WebSocket-Extensions</code> header is still used to negotiate GRIP:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Sec-WebSocket-Extensions</span><span class="p">:</span> <span class="s">grip</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>

OPEN\r\n
</code></pre></div></div>
<p>At this point, the proxied WebSocket session is established with GRIP activated. If P-8 has a normal WebSocket connection with the origin server, then P-8 and the origin server may exchange WebSocket messages normally. If P-8 has a WebSocket-over-HTTP session with the origin server, then P-8 and the origin server may exchange WebSocket “events” over HTTP.</p>
<p>When a WebSocket session has GRIP mode activated, messages sent from the origin server to P-8 must be prefixed with either <code class="language-plaintext highlighter-rouge">m:</code> (regular message) or <code class="language-plaintext highlighter-rouge">c:</code> (control message). <strong>A message without a prefix will be ignored by P-8.</strong> The prefixing is needed to disambiguate regular messages from control messages. When P-8 receives a regular message in this way, the prefix is stripped before relaying the message to the client.</p>
<p>It is possible to override the regular message prefix by specifying the <code class="language-plaintext highlighter-rouge">message-prefix</code> parameter in the GRIP extension negotiation response. You can even set it to a blank string, allowing you to send normal messages without a prefix, if you’re sure that none of your regular messages will ever begin with <code class="language-plaintext highlighter-rouge">c:</code>. For example:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">101</span> <span class="ne">Switching Protocols</span>
<span class="na">Upgrade</span><span class="p">:</span> <span class="s">websocket</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">Upgrade</span>
<span class="na">Sec-WebSocket-Accept</span><span class="p">:</span> <span class="s">s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span>
<span class="na">Sec-WebSocket-Extensions</span><span class="p">:</span> <span class="s">grip; message-prefix=""</span>
</code></pre></div></div>
<p>Control messages are formatted as a JSON object following the <code class="language-plaintext highlighter-rouge">c:</code> prefix. The object has a <code class="language-plaintext highlighter-rouge">type</code> field that indicates the type of control message. All other fields of the object depend on the type.</p>
<p>There are three possible control messages:</p>
<ul>
<li><code class="language-plaintext highlighter-rouge">subscribe</code>: Subscribe connection to the channel specified by the <code class="language-plaintext highlighter-rouge">channel</code> field.</li>
<li><code class="language-plaintext highlighter-rouge">unsubscribe</code>: Unsubscribe connection from the channel specified by the <code class="language-plaintext highlighter-rouge">channel</code> field.</li>
<li><code class="language-plaintext highlighter-rouge">detach</code>: Terminate the session between P-8 and the origin server, but retain the connection between the client and P-8. Any messages P-8 receives from the client will be dropped.</li>
</ul>
<p>Here’s how the origin server would subscribe a connection to a channel called “mychannel”:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:{"type": "subscribe", "channel": "mychannel"}
</code></pre></div></div>
<p>If you are using WebSocket-over-HTTP communication, then the message must be wrapped in a <code class="language-plaintext highlighter-rouge">TEXT</code> event and sent in an HTTP response:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>

TEXT 2F\r\n
c:{"type": "subscribe", "channel": "mychannel"}\r\n
</code></pre></div></div>
<p>Accepting a WebSocket-over-HTTP connection and subscribing it to a channel is easy in your favorite language. Our server libraries take care of encoding events for you:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install gripcontrol
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">WebSocketEvent</span><span class="p">,</span> \
    <span class="n">decode_websocket_events</span><span class="p">,</span> <span class="n">encode_websocket_events</span><span class="p">,</span> \
    <span class="n">websocket_control_message</span>

<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
    <span class="n">in_events</span> <span class="o">=</span> <span class="n">decode_websocket_events</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">out_events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">in_events</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s">'OPEN'</span><span class="p">:</span>
        <span class="n">out_events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">WebSocketEvent</span><span class="p">(</span><span class="s">'OPEN'</span><span class="p">))</span>
        <span class="n">out_events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">WebSocketEvent</span><span class="p">(</span><span class="s">'TEXT'</span><span class="p">,</span> <span class="s">'c:'</span> <span class="o">+</span>
            <span class="n">websocket_control_message</span><span class="p">(</span><span class="s">'subscribe'</span><span class="p">,</span>
            <span class="p">{</span><span class="s">'channel'</span><span class="p">:</span> <span class="s">'mychannel'</span><span class="p">})))</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">encode_websocket_events</span><span class="p">(</span><span class="n">out_events</span><span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">'application/websocket-events'</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s">'Sec-WebSocket-Extensions'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'grip'</span>
    <span class="k">return</span> <span class="n">resp</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install gripcontrol</span>
<span class="nb">require</span> <span class="s1">'gripcontrol'</span>

<span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Sec-WebSocket-Extensions'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'grip'</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/websocket-events'</span>

    <span class="n">in_events</span> <span class="o">=</span> <span class="no">GripControl</span><span class="p">.</span><span class="nf">decode_websocket_events</span><span class="p">(</span>
        <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">out_events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">in_events</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">type</span> <span class="o">==</span> <span class="s1">'OPEN'</span>
        <span class="n">out_events</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">WebSocketEvent</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'OPEN'</span><span class="p">))</span>
        <span class="n">out_events</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">WebSocketEvent</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'TEXT'</span><span class="p">,</span> <span class="s1">'c:'</span> <span class="o">+</span>
            <span class="no">GripControl</span><span class="p">.</span><span class="nf">websocket_control_message</span><span class="p">(</span><span class="s1">'subscribe'</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">'channel'</span> <span class="o">=&gt;</span> <span class="s1">'mychannel'</span><span class="p">})))</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="no">GripControl</span><span class="p">.</span><span class="nf">encode_websocket_events</span><span class="p">(</span>
        <span class="n">out_events</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// composer require fanout/gripcontrol</span>

<span class="nv">$in_events</span> <span class="o">=</span> <span class="nc">GripControl</span><span class="o">::</span><span class="nf">decode_websocket_events</span><span class="p">(</span>
    <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"php://input"</span><span class="p">));</span>
<span class="nv">$out_events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$in_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'OPEN'</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$out_events</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WebSocketEvent</span><span class="p">(</span><span class="s1">'OPEN'</span><span class="p">);</span>
    <span class="nv">$out_events</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WebSocketEvent</span><span class="p">(</span><span class="s1">'TEXT'</span><span class="p">,</span> <span class="s1">'c:'</span> <span class="mf">.</span>
        <span class="nc">GripControl</span><span class="o">::</span><span class="nf">websocket_control_message</span><span class="p">(</span><span class="s1">'subscribe'</span><span class="p">,</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">'channel'</span> <span class="o">=&gt;</span> <span class="s1">'mychannel'</span><span class="p">)));</span>
<span class="p">}</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/websocket-events'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Sec-WebSocket-Extensions: grip'</span><span class="p">);</span>
<span class="nb">http_response_code</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

<span class="k">echo</span> <span class="nc">GripControl</span><span class="o">::</span><span class="nf">encode_websocket_events</span><span class="p">(</span><span class="nv">$out_events</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="c1">// npm install --save grip</span>
<span class="kd">var</span> <span class="nx">grip</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">grip</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Sec-WebSocket-Extensions</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">grip</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/websocket-events</span><span class="dl">'</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">inEvents</span> <span class="o">=</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">decodeWebSocketEvents</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">outEvents</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">inEvents</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getType</span><span class="p">()</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">OPEN</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">outEvents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">WebSocketEvent</span><span class="p">(</span><span class="dl">'</span><span class="s1">OPEN</span><span class="dl">'</span><span class="p">));</span>
            <span class="nx">outEvents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">WebSocketEvent</span><span class="p">(</span><span class="dl">'</span><span class="s1">TEXT</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">c:</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">webSocketControlMessage</span><span class="p">(</span>
                <span class="dl">'</span><span class="s1">subscribe</span><span class="dl">'</span><span class="p">,</span>
                <span class="p">{</span><span class="dl">'</span><span class="s1">channel</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span><span class="p">})));</span>
        <span class="p">}</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">grip</span><span class="p">.</span><span class="nx">encodeWebSocketEvents</span><span class="p">(</span><span class="nx">outEvents</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0.0.0.0</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install django-grip
</span>
<span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py:
</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># middleware provides a pseudo-socket object
</span>    <span class="n">ws</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">wscontext</span>

    <span class="c1"># if this is a new connection, accept it and subscribe it
</span>    <span class="c1"># to a channel
</span>    <span class="k">if</span> <span class="n">ws</span><span class="p">.</span><span class="n">is_opening</span><span class="p">():</span>
        <span class="n">ws</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="n">ws</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">)</span>

    <span class="c1"># here we loop over any messages
</span>    <span class="k">while</span> <span class="n">ws</span><span class="p">.</span><span class="n">can_recv</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>

        <span class="c1"># if return value is None, then the connection is
</span>        <span class="c1"># closed
</span>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># ack the close
</span>            <span class="n">ws</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>

    <span class="c1"># return an empty response, which middleware will fill
</span>    <span class="c1"># with events
</span>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</code></pre></div> </div>
</div>
<p>Whenever you want to send data to listening clients, publish a “WebSocket message” payload containing the content:</p>
<div class="tabbed-example container">
<div class="language-python highlighter-rouge" data-tab-type="python"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install gripcontrol
</span><span class="kn">from</span> <span class="nn">pubcontrol</span> <span class="kn">import</span> <span class="n">Item</span>
<span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">GripPubControl</span><span class="p">,</span> <span class="n">WebSocketMessageFormat</span>

<span class="n">pub</span> <span class="o">=</span> <span class="n">GripPubControl</span><span class="p">({</span>
    <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">WebSocketMessageFormat</span><span class="p">(</span><span class="s">'{"hello": "world"}'</span><span class="p">))</span>
<span class="n">pub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-ruby highlighter-rouge" data-tab-type="ruby"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install gripcontrol</span>
<span class="nb">require</span> <span class="s1">'pubcontrol'</span>
<span class="nb">require</span> <span class="s1">'gripcontrol'</span>

<span class="n">pub</span> <span class="o">=</span> <span class="no">GripPubControl</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">})</span>

<span class="n">item</span> <span class="o">=</span> <span class="no">Item</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="no">WebSocketMessageFormat</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'{"hello": "world"}'</span><span class="p">))</span>
<span class="n">pub</span><span class="p">.</span><span class="nf">publish_async</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</code></pre></div> </div>
<div class="language-php highlighter-rouge" data-tab-type="php"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="c1">// composer require fanout/gripcontrol</span>

<span class="nv">$pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GripPubControl</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'control_uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://localhost:5561'</span>
<span class="p">));</span>

<span class="nv">$item</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Item</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">WebSocketMessageFormat</span><span class="p">(</span><span class="s1">'{"hello": "world"}'</span><span class="p">));</span>
<span class="nv">$pub</span><span class="o">-&gt;</span><span class="nf">publish</span><span class="p">(</span><span class="s1">'mychannel'</span><span class="p">,</span> <span class="nv">$item</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div> </div>
<div class="language-javascript highlighter-rouge" data-tab-type="nodejs"><div class="highlight"><pre class="highlight"><code><span class="c1">// npm install --save grip</span>
<span class="kd">var</span> <span class="nx">pubcontrol</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">pubcontrol</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">grip</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">grip</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">GripPubControl</span><span class="p">({</span>
    <span class="dl">'</span><span class="s1">control_uri</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:5561</span><span class="dl">'</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pubcontrol</span><span class="p">.</span><span class="nx">Item</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">grip</span><span class="p">.</span><span class="nx">WebSocketMessageFormat</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"hello": "world"}</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">pub</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="dl">'</span><span class="s1">mychannel</span><span class="dl">'</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
</code></pre></div> </div>
<div class="language-python highlighter-rouge" data-tab-type="django"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py:
</span>
<span class="n">GRIP_PROXIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'control_uri'</span><span class="p">:</span> <span class="s">'http://localhost:5561'</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django_grip.GripMiddleware'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>

<span class="c1"># views.py or elsewhere:
</span>
<span class="c1"># pip install django-grip
</span><span class="kn">from</span> <span class="nn">gripcontrol</span> <span class="kn">import</span> <span class="n">WebSocketMessageFormat</span>
<span class="kn">from</span> <span class="nn">django_grip</span> <span class="kn">import</span> <span class="n">publish</span>

<span class="n">publish</span><span class="p">(</span><span class="s">'mychannel'</span><span class="p">,</span>
    <span class="n">WebSocketMessageFormat</span><span class="p">(</span><span class="s">'{"hello": "world"}'</span><span class="p">))</span>
</code></pre></div> </div>
</div>
<p>If there’s no library for your programming language, publishing is just one HTTP POST:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/publish/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mychannel"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"ws-message"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">hello</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">world</span><span class="se">\"</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<h2 id="libraries">Libraries</h2>
<p>There are a number of convenience libraries available for working with P-8 on the server side:</p>
<ul>
<li>Python (<a href="https://github.com/fanout/pygripcontrol">gripcontrol</a>, <a href="https://github.com/fanout/django-grip">django-grip</a>)</li>
<li>Ruby (<a href="https://github.com/fanout/ruby-gripcontrol">gripcontrol</a>, <a href="https://github.com/fanout/rails-grip">rails-grip</a>)</li>
<li>PHP (<a href="https://github.com/fanout/php-gripcontrol">fanout/gripcontrol</a>, <a href="https://github.com/fanout/laravel-grip">laravel-grip</a>)</li>
<li>Node (<a href="https://github.com/fanout/node-grip">grip</a>, <a href="https://github.com/fanout/express-grip">express-grip</a>)</li>
<li>Go (<a href="https://github.com/fanout/go-gripcontrol">go-gripcontrol</a>)</li>
<li>.NET (<a href="https://github.com/realcrowd/grip.net">grip.net</a>)</li>
</ul>
<p>If you’re wondering where the client side libraries are, there aren’t any, because P-8 has no client protocol! Any client libraries would be your own to make.</p>
<h2 id="browser-features">Browser features</h2>
<h3 id="auto-cross-origin">Auto cross-origin</h3>
<p>Many API developers don’t care about cross-origin restrictions. They build an API at <code class="language-plaintext highlighter-rouge">api.example.com</code>, and they just want it to be usable by anyone from anywhere.</p>
<p>To help with this, P-8 has a feature called Auto Cross-Origin. If enabled, P-8 automatically provides CORS and JSONP wrapping on behalf of any backend servers.</p>
<p><strong>Enabling:</strong></p>
<p>To enable Auto Cross-Origin for all routes, set <code class="language-plaintext highlighter-rouge">auto_cross_origin=true</code> in the proxy section of <code class="language-plaintext highlighter-rouge">P-8.conf</code>. To enable Auto Cross-Origin on individual routes, include the <code class="language-plaintext highlighter-rouge">aco</code> parameter in the route condition.</p>
<p>Congrats! Your web service now works from everywhere and you can get on with your life.</p>
<p><strong>Why inside the proxy?</strong></p>
<p>Even though it is possible for backend applications to handle CORS and JSONP on their own, and perhaps quite easily with the right web framework middleware, P-8’s out-of-band push mechanism adds additional complexity here. CORS headers and JSONP framing need to be included in the POST publish commands sent to P-8, otherwise you end up with your non-realtime interactions succeeding but realtime interactions failing.</p>
<p>Having to include CORS information in published payloads is not so bad, as CORS is the modern way of doing things and developers should be quite familiar with it. However, we think it’s terrible that anyone should have to write code related to JSONP in the present day. So, the main motivation of the Auto Cross-Origin feature is to relieve developers from having to maintain legacy JSONP code. That it also handles CORS is a nice bonus.</p>
<p><strong>CORS:</strong></p>
<p>When the Auto Cross-Origin feature is enabled, <code class="language-plaintext highlighter-rouge">Access-Control-*</code> headers are automatically provided:</p>
<ul>
<li>If an HTTP response does not contain an <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code> header, then include this header, set to the value of the request’s <code class="language-plaintext highlighter-rouge">Origin</code> header or to “*”.</li>
<li>If an HTTP response does not contain an <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Methods</code> header, then include this header, set to the value of the request’s <code class="language-plaintext highlighter-rouge">Access-Control-Request-Method</code> header (if provided) or to “OPTIONS, HEAD, GET, POST, PUT, DELETE”.</li>
<li>If an HTTP response does not contain an <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Headers</code> header, then include this header, set to the value of the request’s <code class="language-plaintext highlighter-rouge">Access-Control-Request-Headers</code> header.</li>
<li>If an HTTP response does not contain an <code class="language-plaintext highlighter-rouge">Access-Control-Expose-Headers</code> header, then include this header, set to the list of all other “non-simple” headers and non-CORS headers in the response.</li>
<li>If an HTTP response does not contain an <code class="language-plaintext highlighter-rouge">Access-Allow-Credentials</code> header, then include this header set to “true”.</li>
</ul>
<p><strong>JSONP:</strong></p>
<p>If a GET request is received with a <code class="language-plaintext highlighter-rouge">callback</code> query parameter, then P-8 will proxy the request out as a POST instead. The method can be overriden with the <code class="language-plaintext highlighter-rouge">_method</code> query parameter. Headers can be provided with the <code class="language-plaintext highlighter-rouge">_headers</code> query parameter containing a JSON object of header keys and values. The request body can be provided with the <code class="language-plaintext highlighter-rouge">_body</code> query parameter, containing arbitrary data. It is possible to fine-tune how JSONP works using P-8’s various <code class="language-plaintext highlighter-rouge">jsonp_*</code> condition parameters in the routes file.</p>
<p>There are two JSONP response modes: basic and extended. The default is extended, where the entire HTTP response is encoded in a JSON value passed to the callback:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/javascript</span>

<span class="nx">callback</span><span class="p">({</span>
    <span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">reason</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">headers</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">{</span><span class="se">\"</span><span class="s2">foo</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">bar</span><span class="se">\"</span><span class="s2">}</span><span class="dl">"</span>
<span class="p">});</span>
</code></pre></div></div>
<p>In basic mode, only the response body is provided:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/javascript</span>

<span class="nx">callback</span><span class="p">({</span><span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bar</span><span class="dl">"</span><span class="p">});</span>
</code></pre></div></div>
<p>Notably, in basic mode you lose access to the response code and headers. Also, the body <em>must</em> be JSON, whereas in extended mode the body can be arbitrary data.</p>
<h3 id="sockjs">SockJS</h3>
<p>P-8 is able to translate from the <a href="https://github.com/sockjs">SockJS</a> protocol. This allows you to handle SockJS clients using pure WebSocket backend code. Enable it using the <code class="language-plaintext highlighter-rouge">sockjs</code> route condition parameter.</p>
<p>For example, the following route supports the SockJS protocol on path <code class="language-plaintext highlighter-rouge">/sockjs</code> and forwards it as a WebSocket connection to the backend using path <code class="language-plaintext highlighter-rouge">/</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*,sockjs=/sockjs,sockjs_as_path=/ target:8000
</code></pre></div></div>
<p>This feature also works with the <code class="language-plaintext highlighter-rouge">over_http</code> target parameter, so that an HTTP backend can maintain SockJS connections.</p>
</section>
</div><!-- content -->
<div class="div"></div>
<section class="cta">
<div class="wrapper">
<aside class="github">
<a href="https://github.com/P-8-project/P-8"><img src="../../image/github.svg"/></a>
<section class="meta">
<iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=fanout&amp;repo=P-8&amp;type=watch&amp;count=true" width="110"></iframe>
<iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=fanout&amp;repo=P-8&amp;type=fork&amp;count=true" width="95"></iframe>
</section>
<a class="link" href="https://github.com/P-8-project/P-8">https://github.com/P-8-project/P-8</a>
</aside>
</div>
</section><!-- cta -->
<footer class="primary wrapper">
<nav class="primary" id="top" role="navigation">
<aside class="links">
<a href="../../index.html">Home</a>
<a href="../about/index.html">Docs</a>

<a href="https://github.com/P-8-project/P-8">GitHub</a>
</aside>
<a class="logo" href="../../index.html"><img src="../../image/logo.png"/></a>
</nav>
</footer>
<script src="../../js/main.js"></script>
<script async="" defer="" src="https://buttons.github.io/buttons.js"></script>
</body>
</html>
