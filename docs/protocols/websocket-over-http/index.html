<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>P-8 | Documentation | WebSocket-Over-HTTP Protocol</title>
  <meta name="description" content="Get started with realtime using our developer guide. ">
  <link rel="canonical" href="index.html">
  <link rel="alternate" type="application/rss+xml" title="P-8" href="../../../feed.xml" />

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- open graph info -->
  <meta property="og:title" content="P-8 | Documentation | WebSocket-Over-HTTP Protocol">
  <meta property="og:site_name" content="P-8">
  <meta property="og:type" content="website">
  <meta property="og:description" content="Get started with realtime using our developer guide.">
  <meta property="og:image" content="https://P-8.org/image/icon-300x300.png">
  <meta name="twitter:image" content="https://P-8.org/image/icon-300x300.png" />

  <link rel="icon" type="image/png" href="../../../image/favicon.png">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="../../../css/main.css">

  <!-- APIs -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,400|Merriweather:300,400" rel="stylesheet">

  <!-- jQuery -->
  <script
    src="https://code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"></script>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <script src="../../../js/handlebars.js"></script>
  <script src="../../../js/tabbed-examples.js"></script>
</head>

  <body class="page docs">
    <div style="display: none;"><img src="../../../image/dots-div.svg" /></div>

    <header class="primary wrapper">
  <nav class="primary" role="navigation" id="top">
    <aside class="logo">
      <a href="../../../index.html"><img src="../../../image/logo.png" /></a>
    </aside>
    <aside class="links">
      <a href="../../about/index.html">Docs</a>
      <a href="https://github.com/P-8-project/P-8">Code</a>
      <a href="../../about/index.html#support">Community</a>
    </aside>
    <img class="mobile-handle" src="../../../image/mobile-handle.svg" />
  </nav>
</header>

<div class="consent-box" id="consent-box">
  <div class="width">
    <p>We use cookies to provide our services and for analytics and marketing. To find out more about our use of cookies, please see our <a href="https://fanout.io/legal/privacy-policy/">Privacy Policy</a>. By continuing to browse our website, you agree to our use of cookies.</p>
    <button href="#" class="button ghost" id="consent-ok">OK</button>
  </div>
</div>


    <header class="page-header"><h1>Documentation</h1></header>
    <div class="div"></div>

    <div class="content wrapper" style="position: relative;">
      <nav class="sidebar">
        <ul>
          
          
          <li><a href="../../about/index.html">About</a></li>
          
            <ul>
              
              <li><a href="../../about/index.html#introduction">Introduction</a></li>
              
              
              <li><a href="../../about/index.html#how-it-works">How it works</a></li>
              
              
              <li><a href="../../about/index.html#support">Support</a></li>
              
              
              <li><a href="../../about/index.html#license">License</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../../install/index.html">Install</a></li>
          
            <ul>
              
              <li><a href="../../install/index.html#packages">Packages</a></li>
              
              
              <li><a href="../../install/index.html#building-from-source">Building from source</a></li>
              
              
              <li><a href="../../install/index.html#running">Running</a></li>
              
              
              <li><a href="../../install/index.html#upgrading">Upgrading</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../../getting-started/index.html">Getting started</a></li>
          
            <ul>
              
              <li><a href="../../getting-started/index.html#quickstart">Quickstart</a></li>
              
              
              <li><a href="../../getting-started/index.html#video-walkthrough">Video walkthrough</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../../configuration/index.html">Configuration</a></li>
          
            <ul>
              
              <li><a href="../../configuration/index.html#config-files">Config files</a></li>
              
              
              <li><a href="../../configuration/index.html#routes">Routes</a></li>
              
              
              <li><a href="../../configuration/index.html#proxying">Proxying</a></li>
              
              
              <li><a href="../../configuration/index.html#ssl">SSL</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../../usage/index.html">Usage</a></li>
          
            <ul>
              
              <li><a href="../../usage/index.html#subscribing">Subscribing</a></li>
              
              
              <li><a href="../../usage/index.html#publishing">Publishing</a></li>
              
              
              <li><a href="../../usage/index.html#transports">Transports</a></li>
              
              
              <li><a href="../../usage/index.html#libraries">Libraries</a></li>
              
              
              <li><a href="../../usage/index.html#browser-features">Browser features</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../../advanced/index.html">Advanced topics</a></li>
          
            <ul>
              
              <li><a href="../../advanced/index.html#sequence-ids">Sequence IDs</a></li>
              
              
              <li><a href="../../advanced/index.html#message-de-duping">Message de-duping</a></li>
              
              
              <li><a href="../../advanced/index.html#keep-alives">Keep-alives</a></li>
              
              
              <li><a href="../../advanced/index.html#commands">Commands</a></li>
              
              
              <li><a href="../../advanced/index.html#stats-socket">Stats socket</a></li>
              
              
              <li><a href="../../advanced/index.html#message-filtering">Message filtering</a></li>
              
              
              <li><a href="../../advanced/index.html#paged-streaming">Paged streaming</a></li>
              
              
              <li><a href="../../advanced/index.html#reliability">Reliability</a></li>
              
              
              <li><a href="../../advanced/index.html#message-queues">Message queues</a></li>
              
              
              <li><a href="../../advanced/index.html#subscription-forwarding">Subscription forwarding</a></li>
              
              
              <li><a href="../../advanced/index.html#multiple-processes">Multiple processes</a></li>
              
              
              <li><a href="../../advanced/index.html#proxy-chaining">Proxy chaining</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../../examples/index.html">Examples</a></li>
          
            <ul>
              
              <li><a href="../../examples/index.html#headline">Headline</a></li>
              
              
              <li><a href="../../examples/index.html#leaderboard">Leaderboard</a></li>
              
              
              <li><a href="../../examples/index.html#chat">Chat</a></li>
              
              
              <li><a href="../../examples/index.html#todo-list">Todo list</a></li>
              
              
              <li><a href="../../examples/index.html#live-text-editor">Live text editor</a></li>
              
              
              <li><a href="../../examples/index.html#webhookinbox">WebhookInbox</a></li>
              
              
              <li><a href="../../examples/index.html#audio-stream">Audio stream</a></li>
              
              
            </ul>
          
          
          
          <li><a href="../index.html">Protocols</a></li>
          
            <ul>
              
              <li><a href="../grip/index.html">Generic Realtime Intermediary Protocol</a></li>
              
              
              <li><a href="index.html">WebSocket-over-HTTP</a></li>
              
              
              <li><a href="https://rfc.zeromq.org/spec:33/ZHTTP/">ZHTTP</a></li>
              
              
            </ul>
          
          
        </ul>
      </nav>

      <nav class="navbar-mobile-handle">Docs Menu</nav>

      <section class="docs">
      <h1 id="websocket-over-http-protocol">WebSocket-Over-HTTP Protocol</h1>

<p>The WebSocket-Over-HTTP protocol is a simple, text-based protocol for gatewaying between a WebSocket client and a conventional HTTP server.</p>

<h2 id="why">Why?</h2>

<p>P-8’s <a href="../grip/index.html">Generic Realtime Intermediary Protocol (GRIP)</a> enables out-of-band message injection into WebSocket connections. Normally, using GRIP with WebSockets requires a WebSocket connection on both sides of the proxy:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Client &lt;--WS--&gt; GRIP Proxy &lt;--WS--&gt; Server
</code></pre></div></div>

<p>The GRIP Proxy is a publish/subscribe service. When the server has data to send spontaneously, it does not use its WebSocket connection to send the data. Rather, it uses an out-of-band publish command to the proxy (usually via HTTP POST). This means that the WebSocket connection between the proxy and the server is used almost exclusively for servicing incoming requests from the client.</p>

<p>If the communication path between the proxy and the server only needs to handle request/response interactions, then HTTP becomes a viable alternative to a WebSocket:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Client &lt;--WS--&gt; GRIP Proxy &lt;--HTTP--&gt; Server
</code></pre></div></div>

<p>Using HTTP for communication between the proxy and server may be easier to maintain and scale since HTTP server tools are well established. Plus, if the server is merely doing stateless RPC processing, then HTTP is arguably a respectable choice for this tier in the service.</p>

<p>Of course, the usefulness of this gatewaying is entirely dependent on the server having a way to send data to clients out-of-band. As such, it is recommended that the WebSocket-Over-HTTP protocol be used in combination with GRIP. Note, however, that the WebSocket-Over-HTTP protocol does not explicitly depend on GRIP.</p>

<h2 id="protocol">Protocol</h2>

<p>The gateway and server exchange WebSocket “events” via HTTP requests and responses. The following events are defined:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">OPEN</code> - WebSocket negotiation request or acknowledgement.</li>
  <li><code class="language-plaintext highlighter-rouge">TEXT</code>, <code class="language-plaintext highlighter-rouge">BINARY</code> - Messages with content.</li>
  <li><code class="language-plaintext highlighter-rouge">PING</code>, <code class="language-plaintext highlighter-rouge">PONG</code> - Ping and pong messages.</li>
  <li><code class="language-plaintext highlighter-rouge">CLOSE</code> - Close message with 16-bit close code.</li>
  <li><code class="language-plaintext highlighter-rouge">DISCONNECT</code> - Indicates connection closed uncleanly or does not exist.</li>
</ul>

<p>Events are encoded in a format similar to HTTP chunked transfer encoding:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TEXT B\r\n
hello world\r\n
</code></pre></div></div>

<p>The format is the name of the event, a space, the hexidecimal encoding of the content size, a carriage return and newline, the content bytes, and finally another carriage return and newline.</p>

<p>For events with no content, the size and content section can be omitted:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPEN\r\n
</code></pre></div></div>

<p>Events with content are TEXT, BINARY, and CLOSE. Events without content are OPEN, PING, PONG, and DISCONNECT.</p>

<p>An event that should not contain content MAY be encoded with content. Receivers should ignore such content. For example, this is legal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPEN 0\r\n
\r\n
</code></pre></div></div>

<p>One or more encoded events are then concatenated and placed in the body of an HTTP request or response, with content type <code class="language-plaintext highlighter-rouge">application/websocket-events</code>.</p>

<h2 id="example">Example</h2>

<p>Gateway opens connection:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/target</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Connection-Id</span><span class="p">:</span> <span class="s">b5ea0e11</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="s">[... any headers included by the client WebSocket handshake ...]</span>

OPEN\r\n
</code></pre></div></div>

<p>Server accepts connection:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="s">[... any headers to include in the WebSocket negotiation response ...]</span>

OPEN\r\n
</code></pre></div></div>

<p>Gateway relays message from client:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/target</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Connection-Id</span><span class="p">:</span> <span class="s">b5ea0e11</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>

TEXT 5\r\n
hello\r\n
</code></pre></div></div>

<p>Server responds with two messages:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>

TEXT 5\r\n
world\r\n
TEXT 1C\r\n
here is another nice message\r\n
</code></pre></div></div>

<p>Gateway relays a close message:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/target</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Connection-Id</span><span class="p">:</span> <span class="s">b5ea0e11</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>

CLOSE 2\r\n
[... binary status code ...]\r\n
</code></pre></div></div>

<p>Server sends a close message back:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>

CLOSE 2\r\n
[... binary status code ...]\r\n
</code></pre></div></div>

<h2 id="state-management">State Management</h2>

<p>Headers of the initial WebSocket negotiation request MUST be replayed with every request made by the gateway. This means that if the client uses cookies or other headers for authentication purposes, the server will receive this data with every message.</p>

<p>The gateway includes a <code class="language-plaintext highlighter-rouge">Connection-Id</code> header which uniquely identifies a particular client connection. Servers that need to track connections can use this. In most cases, though, servers should not have to care about connections.</p>

<p>It is possible to bind metadata to the connection via a <code class="language-plaintext highlighter-rouge">Set-Meta-*</code> header. This works similar to a cookie. The server can set a field that the gateway should echo back on all subsequent requests.</p>

<p>For example, a client supplies a cookie with a short expiration which the gateway relays across during connect:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/target</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Connection-Id</span><span class="p">:</span> <span class="s">b5ea0e11</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">[... auth info ...]</span>

OPEN\r\n
</code></pre></div></div>

<p>The server accepts the connection and binds a User field based on the cookie:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="na">Set-Meta-User</span><span class="p">:</span> <span class="s">alice</span>

OPEN\r\n
</code></pre></div></div>

<p>Now, any further requests from the gateway will include a Meta-User header, which the server can check instead of the cookie:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/target</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Connection-Id</span><span class="p">:</span> <span class="s">b5ea0e11</span>
<span class="na">Meta-User</span><span class="p">:</span> <span class="s">alice</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">[... auth info ...]</span>

TEXT 5\r\n
hello\r\n
</code></pre></div></div>

<p>Security note: gateways MUST NOT relay any headers from the client that are prefixed with <code class="language-plaintext highlighter-rouge">Meta-</code>. This prevents the client from spoofing metadata bindings. Additionally, the server needs to ensure that an incoming request came from a gateway before trusting its <code class="language-plaintext highlighter-rouge">Meta-*</code> headers.</p>

<h2 id="keep-alives">Keep Alives</h2>

<p>If the server is tracking connections, it will need a way to reliably detect when connections have gone away. The gateway will try to send <code class="language-plaintext highlighter-rouge">CLOSE</code> or <code class="language-plaintext highlighter-rouge">DISCONNECT</code> events on a best-effort basis, but if such events are not received by the server then connection state may linger on the server side. To work around this, the server should enable keep alives and timeout connections when they become inactive.</p>

<p>To enable keep alives, the server responds with a <code class="language-plaintext highlighter-rouge">Keep-Alive-Interval</code> header specifying a value in seconds:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/websocket-events</span>
<span class="na">Keep-Alive-Interval</span><span class="p">:</span> <span class="s">120</span>
</code></pre></div></div>

<p>This header tells the gateway to make a request to the server whenever the specified amount of time has passed since the last request, even if there are no events to send to the server yet (in which case the request body will be empty).</p>

<p>Please note this setting is not acknowledged by the gateway, and the gateway may enforce a minimum value. For compatibility with environments where a minimum may not be known, it is recommended that a conservative value be chosen, no less than <code class="language-plaintext highlighter-rouge">30</code>.</p>

<h2 id="notes">Notes</h2>

<ul>
  <li>The first request MUST contain an OPEN event as the first event.</li>
  <li>The first response MUST contain an OPEN event as the first event.</li>
  <li>If the server tracks connections and no longer considers the connection to exist, it should respond with DISCONNECT. In most cases, servers will not track connections, though.</li>
  <li>Gateway should only have one outstanding request per client connection. This ensures in-order delivery.</li>
  <li>DISCONNECT event only sent if connection was not closed cleanly. With clean close, disconnect is implied.</li>
</ul>

      </section>

    </div><!-- content -->

    <div class="div"></div>

    <section class="cta">
      <div class="wrapper">

        <aside class="github">
          <a href="https://github.com/P-8-project/P-8"><img src="../../../image/github.svg"></a>
          <section class="meta">
            <iframe src="http://ghbtns.com/github-btn.html?user=fanout&repo=P-8&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
            <iframe src="http://ghbtns.com/github-btn.html?user=fanout&repo=P-8&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
          </section>
          <a class="link" href="https://github.com/P-8-project/P-8">https://github.com/P-8-project/P-8</a>
        </aside>

      </div>
    </section><!-- cta -->

    <footer class="primary wrapper">
  <nav class="primary" role="navigation" id="top">
    <aside class="links">
      <a href="../../../index.html">Home</a>
      <a href="../../about/index.html">Docs</a>
      <a href="../../about/index.html#support">Community</a>
      <a href="https://github.com/P-8-project/P-8">GitHub</a>
    </aside>
    <a class="logo" href="../../../index.html"><img src="../../../image/logo.png" /></a>
  </nav>
  <aside class="fanout">
    Brought to you by <a href="https://fastly.com"><img src="../../../image/fastly.svg" /></a>
    <small>&copy; 2025 Fastly, Inc.</small>
  </aside>
</footer>
<script src="../../../js/main.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>


  </body>
</html>
